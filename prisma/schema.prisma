generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Store {
  id           String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  slug         String   @unique @db.VarChar(100)
  name         String   @db.VarChar(255)
  settingsJson Json?
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @db.Timestamp(6)

  auditLogs       AuditLog[]
  categories      Category[]
  itemModifiers   ItemModifier[]
  items           Item[]
  kitchenCounters KitchenCounter[]
  modifierOptions ModifierOption[]
  modifiers       Modifier[]
  orders          Order[]
  profiles        Profile[]
  qrTiles         QRTile[]
  storeMeta       StoreMeta?
  tableVisits     TableVisit[]
  tables          Table[]
  waiterShifts    WaiterShift[]
  waiterTables    WaiterTable[]

  @@index([createdAt(sort: Desc)])
  @@map("stores")
}

model StoreMeta {
  storeId      String   @id @db.Uuid
  currencyCode String   @db.VarChar(8)
  locale       String   @db.VarChar(16)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @db.Timestamp(6)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("store_meta")
}

model Category {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId   String   @db.Uuid
  slug      String   @db.VarChar(100)
  title     String   @db.VarChar(255)
  titleEl   String?  @db.VarChar(255)
  titleEn   String?  @db.VarChar(255)
  sortOrder Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  items Item[]

  @@unique([storeId, slug])
  @@index([storeId, sortOrder])
  @@map("categories")
}

model Item {
  id         String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId    String  @db.Uuid
  categoryId String  @db.Uuid
  slug       String  @db.VarChar(120)
  title      String  @db.VarChar(255)
  titleEl    String? @db.VarChar(255)
  titleEn    String? @db.VarChar(255)

  // code expects these:
  description   String? @db.VarChar(2000)
  descriptionEl String? @db.VarChar(2000)
  descriptionEn String? @db.VarChar(2000)
  imageUrl      String? @db.VarChar(2000)

  priceCents  Int
  isAvailable Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @db.Timestamp(6)

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  category Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  // code expects `itemModifiers` not `modifiers`
  itemModifiers ItemModifier[]
  orderItems    OrderItem[]

  @@unique([storeId, slug])
  @@index([storeId, categoryId, sortOrder])
  @@map("items")
}

model Modifier {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId     String   @db.Uuid
  slug        String   @db.VarChar(120)
  title       String   @db.VarChar(255)
  titleEl     String?  @db.VarChar(255)
  titleEn     String?  @db.VarChar(255)
  minSelect   Int      @default(0)
  maxSelect   Int      @default(1)
  isAvailable Boolean  @default(true)
  createdAt   DateTime @default(now()) @db.Timestamp(6)
  updatedAt   DateTime @updatedAt @db.Timestamp(6)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  // code expects `modifierOptions`
  modifierOptions ModifierOption[]
  itemLinks       ItemModifier[]

  // keep as-is; code already references orderOptions in some places
  orderOptions OrderItemOption[]

  @@unique([storeId, slug])
  @@index([storeId])
  @@map("modifiers")
}

model ModifierOption {
  id              String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId         String   @db.Uuid
  modifierId      String   @db.Uuid
  slug            String   @db.VarChar(120)
  title           String   @db.VarChar(255)
  titleEl         String?  @db.VarChar(255)
  titleEn         String?  @db.VarChar(255)
  priceDeltaCents Int      @default(0)
  sortOrder       Int      @default(0)
  createdAt       DateTime @default(now()) @db.Timestamp(6)
  updatedAt       DateTime @updatedAt @db.Timestamp(6)

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  modifier Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  orderItemOptions OrderItemOption[]

  @@unique([storeId, modifierId, slug])
  @@index([storeId, modifierId, sortOrder])
  @@map("modifier_options")
}

model ItemModifier {
  id         String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId    String   @db.Uuid
  itemId     String   @db.Uuid
  modifierId String   @db.Uuid
  isRequired Boolean  @default(false)
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @db.Timestamp(6)

  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  item     Item     @relation(fields: [itemId], references: [id], onDelete: Cascade)
  modifier Modifier @relation(fields: [modifierId], references: [id], onDelete: Cascade)

  @@unique([storeId, itemId, modifierId])
  // added to satisfy code's `where: { itemId_modifierId: { ... } }`
  @@unique([itemId, modifierId])
  @@index([storeId, itemId])
  @@map("item_modifiers")
}

model Table {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId   String   @db.Uuid
  label     String   @db.VarChar(50)
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  store        Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  qrTiles      QRTile[]
  orders       Order[]
  tableVisits  TableVisit[]
  waiterTables WaiterTable[]

  @@unique([storeId, label])
  @@index([storeId])
  @@map("tables")
}

model QRTile {
  id      String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId String @db.Uuid

  // IMPORTANT: optional to allow “printed stock tiles” not yet assigned to a table
  tableId String? @db.Uuid

  publicCode String   @unique @db.VarChar(32)
  label      String?  @db.VarChar(100)
  isActive   Boolean  @default(true)
  createdAt  DateTime @default(now()) @db.Timestamp(6)
  updatedAt  DateTime @updatedAt @db.Timestamp(6)

  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  table Table? @relation(fields: [tableId], references: [id], onDelete: Cascade)

  tableVisits TableVisit[]

  // allow 1 assigned tile per table; multiple NULLs are allowed in Postgres unique
  @@unique([storeId, tableId])
  @@index([storeId])
  @@index([tableId])
  @@map("qr_tiles")
}

model TableVisit {
  id           String           @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId      String           @db.Uuid
  tableId      String           @db.Uuid
  tileId       String           @db.Uuid
  sessionToken String           @unique @db.VarChar(64)
  status       TableVisitStatus @default(OPEN)
  createdAt    DateTime         @default(now()) @db.Timestamp(6)
  updatedAt    DateTime         @updatedAt @db.Timestamp(6)
  expiresAt    DateTime?        @db.Timestamp(6)
  closedAt     DateTime?        @db.Timestamp(6)

  store Store  @relation(fields: [storeId], references: [id], onDelete: Cascade)
  table Table  @relation(fields: [tableId], references: [id], onDelete: Cascade)
  tile  QRTile @relation(fields: [tileId], references: [id], onDelete: Cascade)

  @@index([storeId, status])
  @@index([tableId])
  @@map("table_visits")
}

model Order {
  id      String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId String      @db.Uuid
  tableId String      @db.Uuid
  status  OrderStatus @default(PLACED)

  // required by your DB (seed crash) + code now sees it
  paymentStatus PaymentStatus @default(PENDING)

  totalCents Int @default(0)

  // code expects these:
  note         String? @db.VarChar(2000)
  ticketNumber Int? // keep nullable

  placedAt    DateTime  @default(now()) @db.Timestamp(6)
  preparingAt DateTime? @db.Timestamp(6)
  readyAt     DateTime? @db.Timestamp(6)
  servedAt    DateTime? @db.Timestamp(6)
  cancelledAt DateTime? @db.Timestamp(6)
  paidAt      DateTime? @db.Timestamp(6)

  cancelReason String? @db.VarChar(255)

  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)
  table Table @relation(fields: [tableId], references: [id], onDelete: Cascade)

  // code expects `orderItems` not `items`
  orderItems OrderItem[]

  @@index([storeId, placedAt(sort: Desc)])
  @@index([tableId, placedAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderId        String   @db.Uuid
  itemId         String   @db.Uuid
  titleSnapshot  String   @db.VarChar(255)
  unitPriceCents Int
  quantity       Int      @default(1)
  createdAt      DateTime @default(now()) @db.Timestamp(6)
  updatedAt      DateTime @updatedAt @db.Timestamp(6)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  item  Item  @relation(fields: [itemId], references: [id], onDelete: Restrict)

  // code expects `orderItemOptions` not `options`
  orderItemOptions OrderItemOption[]

  @@index([orderId])
  @@map("order_items")
}

model OrderItemOption {
  id               String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  orderItemId      String   @db.Uuid
  modifierId       String   @db.Uuid
  modifierOptionId String   @db.Uuid
  titleSnapshot    String   @db.VarChar(255)
  priceDeltaCents  Int      @default(0)
  createdAt        DateTime @default(now()) @db.Timestamp(6)
  updatedAt        DateTime @updatedAt @db.Timestamp(6)

  orderItem      OrderItem      @relation(fields: [orderItemId], references: [id], onDelete: Cascade)
  modifier       Modifier       @relation(fields: [modifierId], references: [id], onDelete: Restrict)
  modifierOption ModifierOption @relation(fields: [modifierOptionId], references: [id], onDelete: Restrict)

  @@index([orderItemId])
  @@map("order_item_options")
}

model KitchenCounter {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId   String   @db.Uuid
  slug      String   @db.VarChar(100)
  title     String   @db.VarChar(255)
  // Daily sequence for kitchen tickets (YYYY-MM-DD)
  day       String   @db.VarChar(10)
  seq       Int      @default(0)
  createdAt DateTime @default(now()) @db.Timestamp(6)
  updatedAt DateTime @updatedAt @db.Timestamp(6)

  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([storeId, slug])
  @@unique([storeId, day])
  @@index([storeId])
  @@map("kitchen_counters")
}

model WaiterShift {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId   String      @db.Uuid
  waiterId  String      @db.Uuid
  status    ShiftStatus @default(SCHEDULED)
  startedAt DateTime?   @db.Timestamp(6)
  endedAt   DateTime?   @db.Timestamp(6)
  createdAt DateTime    @default(now()) @db.Timestamp(6)
  updatedAt DateTime    @updatedAt @db.Timestamp(6)

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  waiter Profile @relation(fields: [waiterId], references: [id], onDelete: Restrict)

  @@index([storeId, status])
  @@index([waiterId])
  @@map("waiter_shifts")
}

model WaiterTable {
  id       String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId  String @db.Uuid
  waiterId String @db.Uuid
  tableId  String @db.Uuid

  // code orders by createdAt; add it
  createdAt DateTime @default(now()) @db.Timestamp(6)

  store  Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)
  waiter Profile @relation(fields: [waiterId], references: [id], onDelete: Restrict)
  table  Table   @relation(fields: [tableId], references: [id], onDelete: Cascade)

  @@unique([storeId, waiterId, tableId])
  @@index([storeId])
  @@index([waiterId])
  @@index([tableId])
  @@map("waiter_tables")
}

model AuditLog {
  id             String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  storeId        String   @db.Uuid
  ts             DateTime @default(now()) @db.Timestamp(6)
  action         String   @db.VarChar(100)
  entityType     String   @db.VarChar(100)
  entityId       String?  @db.Uuid
  metaJson       Json?
  actorProfileId String?  @db.Uuid

  actorProfile Profile? @relation(fields: [actorProfileId], references: [id])
  store        Store    @relation(fields: [storeId], references: [id])

  @@index([storeId, ts(sort: Desc)])
  @@map("audit_logs")
}

model Profile {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // NULL => global profile (e.g. central ARCHITECT)
  storeId String? @db.Uuid

  email String @db.VarChar(255)

  // global uniqueness for global users (architect)
  globalKey String? @unique @db.VarChar(300)

  passwordHash String   @db.VarChar(255)
  role         Role
  displayName  String?  @db.VarChar(255)
  createdAt    DateTime @default(now()) @db.Timestamp(6)
  updatedAt    DateTime @updatedAt @db.Timestamp(6)
  ratingAvg    Decimal? @db.Decimal(4, 2)
  isVerified   Boolean  @default(false)

  auditLogs    AuditLog[]
  store        Store?        @relation(fields: [storeId], references: [id])
  waiterShifts WaiterShift[]
  waiterTables WaiterTable[]

  @@unique([storeId, email])
  @@index([storeId, role])
  @@index([email])
  @@map("profiles")
}

enum TableVisitStatus {
  OPEN
  CLOSED
  EXPIRED
}

enum ShiftStatus {
  SCHEDULED
  ACTIVE
  ENDED
}

enum Role {
  GUEST
  WAITER
  MANAGER
  COOK
  ARCHITECT
}

enum OrderStatus {
  PLACED
  PREPARING
  READY
  SERVED
  CANCELLED
  PAID
}

enum PaymentStatus {
  PENDING
  COMPLETED
  CANCELLED
  FAILED
}
